<!DOCTYPE html>
<html lang="en">
<head>
  <title> Mapping NYC by jobs</title>
  <meta name="author" content="Sundar Singh | eesur.com">
    <meta charset="utf-8"/>
  <link rel="stylesheet" href="main.css">
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>
<body>

    <header>
        <h2> Mapping NYC: A Exploration Of Its Job Market   </h2>  <span>  by Joanna Lin Su <link </span></br><img src="bg.png" width="70%"> </header>

    <div class="content">
        <p> When Fitz Gerald first called NYC "the Big Apple", he probably didn't think about that the term would go this popular now. People are describing New
            York as "a city that never sleeps", "the center of the universe", or even as "a trap". Tourists around the globe come to New York to see the charging bull from the Wall
            Street, to go shopping on the Fifth Avenue, or to watch performing arts at Broadway...  </p>
            <p> But, except all these fancy labels, how does the city function everyday? What are the average people doing in their day to day life?
            So I look into its job market, trying to figure out what does New York actually look
            like. </p>
            <p> Here is a general sense: New York City is home to more than 4 million jobs. It uses 2.5% of the total labor market of the States in generating
                5% of the U.S. total wages. </p>
            <p>You may probably already have a good sense of how these jobs
                locate geographically. But the size of each parts is still vague, neither does how much they earn. </p>

            <p> The following treemap is an experiment, through which it shows more than half of the total jobs are about business, professional, and services. While in general "office and administrative support" has most people working on, NYC has about 147 thousand home health aides(under the "healthcare support" category), more than any other job titles. As a
                journalist, it is also surprised for me to see that the city has way fewer reporters and correspondents than personal relation specialists, editors, or even graphic designers. What about your industry?</p> </div>




    <div id="chart">

    <script src="https://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>


    <script>
        window.addEventListener('message', function(e) {
            var opts = e.data.opts,
                data = e.data.data;

            return main(opts, data);
        });

        var defaults = {
            margin: {top: 24, right: 0, bottom: 0, left: 0},
            rootname: "TOP",
            format: ",d",
            title: "",
            width: 1400,
            height: 800,
        };

        function main(o, data) {
            var root,
                opts = $.extend(true, {}, defaults, o),
                formatNumber = d3.format(opts.format),
                rname = opts.rootname,
                margin = opts.margin,
                theight = 36 + 16;

            $('#chart').width(opts.width).height(opts.height);
            var width = opts.width - margin.left - margin.right,
                height = opts.height - margin.top - margin.bottom - theight,
                transitioning;

            var color = d3.scale.category20b();


            var x = d3.scale.linear()
                .domain([0, width])
                .range([0, width]);

            var y = d3.scale.linear()
                .domain([0, height])
                .range([0, height]);

            var treemap = d3.layout.treemap()
                .children(function(d, depth) { return depth ? null : d._children; })
                .sort(function(a, b) { return a.value - b.value; })
                .ratio(height / width * 0.1* (1 + Math.sqrt(5)))
                .round(false);

            var svg = d3.select("#chart").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.bottom + margin.top)
                .style("margin-left", -margin.left + "px")
                .style("margin.right", -margin.right + "px")
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .style("shape-rendering", "crispEdges");

            var grandparent = svg.append("g")
                .attr("class", "grandparent");

            grandparent.append("rect")
                .attr("y", -margin.top)
                .attr("width", width)
                .attr("height", margin.top);

            grandparent.append("text")
                .attr("x", 6)
                .attr("y", 6 - margin.top)
                .attr("dy", ".75em");

            if (opts.title) {
                $("#chart").prepend("<p class='title'>" + opts.title + "</p>");
            }
            if (data instanceof Array) {
                root = { key: rname, values: data };
            } else {
                root = data;
            }

            initialize(root);
            accumulate(root);
            layout(root);
            console.log(root);
            display(root);

            if (window.parent !== window) {
                var myheight = document.documentElement.scrollHeight || document.body.scrollHeight;
                window.parent.postMessage({height: myheight}, '*');
            }

            function initialize(root) {
                root.x = root.y = 0;
                root.dx = width;
                root.dy = height;
                root.depth = 0;
            }

            // Aggregate the values for internal nodes. This is normally done by the
            // treemap layout, but not here because of our custom implementation.
            // We also take a snapshot of the original children (_children) to avoid
            // the children being overwritten when when layout is computed.
            function accumulate(d) {
                return (d._children = d.values)
                    ? d.value = d.values.reduce(function(p, v) { return p + accumulate(v); }, 0)
                    : d.value;
            }

            // Compute the treemap layout recursively such that each group of siblings
            // uses the same size (1×1) rather than the dimensions of the parent cell.
            // This optimizes the layout for the current zoom state. Note that a wrapper
            // object is created for the parent node for each group of siblings so that
            // the parent’s dimensions are not discarded as we recurse. Since each group
            // of sibling was laid out in 1×1, we must rescale to fit using absolute
            // coordinates. This lets us use a viewport to zoom.
            function layout(d) {
                if (d._children) {
                    treemap.nodes({_children: d._children});
                    d._children.forEach(function(c) {
                        c.x = d.x + c.x * d.dx;
                        c.y = d.y + c.y * d.dy;
                        c.dx *= d.dx;
                        c.dy *= d.dy;
                        c.parent = d;
                        layout(c);
                    });
                }
            }

            function display(d) {
                grandparent
                    .datum(d.parent)
                    .on("click", transition)
                    .select("text")
                    .text(name(d));

                var g1 = svg.insert("g", ".grandparent")
                    .datum(d)
                    .attr("class", "depth");

                var g = g1.selectAll("g")
                    .data(d._children)
                    .enter().append("g");

                g.filter(function(d) { return d._children; })
                    .classed("children", true)
                    .on("click", transition);

                var children = g.selectAll(".child")
                    .data(function(d) { return d._children || [d]; })
                    .enter().append("g");

                children.append("rect")
                    .attr("class", "child")
                    .call(rect)
                    .append("title")
                    .text(function(d) { return d.key + " (" + formatNumber(d.value) + ")"; });
                children.append("text")
                    .attr("class", "ctext")
                    .text(function(d) { return d.key; })
                    .call(text2);

                g.append("rect")
                    .attr("class", "parent")
                    .call(rect);

                var t = g.append("text")
                    .attr("class", "ptext")
                    .attr("dy", "0.5em")

                t.append("tspan")
                    .text(function(d) { return d.key; });
                t.append("tspan")
                    .attr("dy", "1.0em")
                    .text(function(d) { return formatNumber(d.value); });
                t.call(text);

                g.selectAll("rect")
                    .style("fill", function(d) { return color(d.key); });

                function transition(d) {
                    if (transitioning || !d) return;
                    transitioning = true;

                    var g2 = display(d),
                        t1 = g1.transition().duration(100),
                        t2 = g2.transition().duration(100);

                    // Update the domain only after entering new elements.
                    x.domain([d.x, d.x + d.dx]);
                    y.domain([d.y, d.y + d.dy]);

                    // Enable anti-aliasing during the transition.
                    svg.style("shape-rendering", null);

                    // Draw child nodes on top of parent nodes.
                    svg.selectAll(".depth").sort(function(a, b) { return a.depth - b.depth; });

                    // Fade-in entering text.
                    g2.selectAll("text").style("fill-opacity", 0.5);

                    // Transition to the new view.
                    t1.selectAll(".ptext").call(text).style("fill-opacity", 0);
                    t1.selectAll(".ctext").call(text2).style("fill-opacity", 0);
                    t2.selectAll(".ptext").call(text).style("fill-opacity", 1);
                    t2.selectAll(".ctext").call(text2).style("fill-opacity", 1);
                    t1.selectAll("rect").call(rect);
                    t2.selectAll("rect").call(rect);

                    // Remove the old node when the transition is finished.
                    t1.remove().each("end", function() {
                        svg.style("shape-rendering", "crispEdges");
                        transitioning = false;
                    });
                }

                return g;
            }

            function text(text) {
                text.selectAll("tspan")
                    .attr("x", function(d) { return x(d.x) + 6; })
                text.attr("x", function(d) { return x(d.x) + 6; })
                    .attr("y", function(d) { return y(d.y) + 6; })
                    .style("opacity", function(d) { return this.getComputedTextLength() < x(d.x + d.dx) - x(d.x) ? 0.9: 0.5; });
            }

            function text2(text) {
                text.attr("x", function(d) { return x(d.x + d.dx) - this.getComputedTextLength() - 6; })
                    .attr("y", function(d) { return y(d.y + d.dy) - 6; })
                    .style("opacity", function(d) { return this.getComputedTextLength() < x(d.x + d.dx) - x(d.x) ? 0.9 : 0.5; });
            }

            function rect(rect) {
                rect.attr("x", function(d) { return x(d.x); })
                    .attr("y", function(d) { return y(d.y); })
                    .attr("width", function(d) { return x(d.x + d.dx) - x(d.x); })
                    .attr("height", function(d) { return y(d.y + d.dy) - y(d.y); });
            }

            function name(d) {
                return d.parent
                    ? name(d.parent) + " ==> " + d.key + " (" + formatNumber(d.value) + ")"
                    : d.key + " (" + formatNumber(d.value) + ")";
            }
        }

        if (window.location.hash === "") {
            d3.json("data2.json", function(err, res) {
                if (!err) {
                    console.log(res);
                    var data = d3.nest().key(function(d) { return d.region; }).key(function(d) { return d.subregion; }).entries(res);
                    main({title: "Click to explore 4 million jobs in NYC. 👇 </br> How to play? </br> -By clicking on each block, you will get to know more about its subcategories.</br> -By hovering on each block, you will get more information pumping out. </br> -By clicking 'NYC Total' to get back. "}, {key: "NYC Total", values: data});
                }
            });
        }

    </script>
    </div>

   <div class="wage">
       <p> <span> When grouped by occupations, these are among the top list.👇 </span></p>
</br></br><img src="rank.png" width="80%">

    <p> Regarding the wage, there is no much difference when it comes to the entry level jobs except one occupation- management. Managers, who are the sixth largest group in NYC job market, have much higher wages even when they are just getting started. The wage ceilings are quite
        different for each occupation. They generally go into three bundles while lawyers and salespeople are having the most "robust potential".
        And home health aids, the job has most New Yorkers working on, is offering the lowest income. </br> </br> <span> Explore it yourself! 👇 </span></p> </div>

    <div class="slopegraph">
       <section id="slopegraph"></section>

    <footer>
        <button id="reset">Select All</button>
        <nav id='nav-alt'></nav>
    </footer>


    <!-- namespace -->
    <script> d3.eesur = {}; </script>
    <!-- reusable slopegraph -->

    <script src="d3_code_slopegraph.js"></script>
    <script>

        //  render slopegraph chart

        (function() {


            // create chart
            var slopegraph = d3.eesur.slopegraph()
                .margin({top: 20, bottom: 20, left: 60, right:100})
                .strokeColour('black')
                .keyName('Occupation')
                .keyValueStart('Entry')
                .keyValueEnd('Experienced')
                .h(1000)
                .format(d3.format('04d'))
                .on('_hover', function (d, i) {
                    highlightLine(d, i);
                });


            d3.json('csvjson.json', function(error, data) {

                if (error) throw error;

                // render chart
                d3.select('#slopegraph')
                    .datum(data)
                    .call(slopegraph);

                // alternative navigation
                navAlt(data);
            });

            // reset button listener
            d3.select('#reset')
                .on('click', function () {
                    d3.selectAll('.elm').transition().style('opacity', 1);
                    d3.selectAll('.s-line').style('stroke','#130C0E');
                });

            // navigation
            function navAlt(data) {
                d3.select('#nav-alt').append('ul')
                    .selectAll('li')
                    .data(data)
                    .enter().append('li')
                    .on('click', function (d, i) {
                        highlightLine(d, i);
                    })
                    .text(function (d) { return d['Occupation']; });
            }

            // highlight line and fade other lines
            function highlightLine(d, i) {
                d3.selectAll('.elm').transition().style('opacity', 0.2);
                d3.selectAll('.sel-' + i).transition().style('opacity', 1);
                d3.selectAll('.s-line').style('stroke', '#FDBB30');
                d3.selectAll('.s-line.sel-' + i).style('stroke', '#130C0E');
            }

            // just for blocks viewer size
            //d3.select(self.frameElement).style('height', '800px');

        }());

    </script>
    </div>

    <div class="call"><p> Want to share your thoughts after the exploration? contact me 👉sulinjoanna[at]gmail.com </p> </div>
<div class="method">
    <hr>
    Data source: New York State Department of Labor,<a href="https://labor.ny.gov/stats/lswage2.asp" target="blank"> Occupational Wages for the New York City Region. </a>  </br> </br>
    Data parsing includes: combining and calculating the "N/A"s; grouping occupations based on the codes; transferring csv file into json.</br></br>
    Visualization packages: <a href="http://bl.ocks.org/ganeshv/6a8e9ada3ab7f2d88022" target="blank"> Zoomable D3.js Treemap</a> and <a href="http://bl.ocks.org/eesur/a4679ee453aa9357977c" target="blank"> Reusable Slopegraph </a>
    </br> </br> <a href="https://joannalinsu.github.io/"> More about me </a>
   </a>


</div></div>

</body>
</html>
